<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Background Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; margin: 10px 0; }
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        input[type="file"] { margin: 10px 0; padding: 5px; }
    </style>
</head>
<body>
    <h1>üß™ Academic Background Upload Test</h1>
    <p>Test the new Cloudinary integration for Academic Background certificate uploads.</p>

    <div>
        <h2>üìÅ Upload Test</h2>
        <input type="file" id="testFile" accept=".pdf,.jpg,.jpeg,.png" multiple />
        <button onclick="testUpload()" id="uploadBtn">Test Upload to Cloudinary</button>
        <div id="uploadLog" class="log" style="display: none;"></div>
        <div id="result" style="margin-top: 10px;"></div>
    </div>

    <script>
        // Same configuration as your app
        const CLOUDINARY_CLOUD_NAME = 'dyvabxsvh';
        const CLOUDINARY_UPLOAD_PRESET = 'ucaes_admissions';
        const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

        function log(message) {
            const logElement = document.getElementById('uploadLog');
            logElement.style.display = 'block';
            logElement.textContent += new Date().toISOString() + ': ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            const logElement = document.getElementById('uploadLog');
            logElement.textContent = '';
            logElement.style.display = 'none';
        }

        function validateFile(file) {
            log(`üîç Validating file: ${file.name} (${file.size} bytes, ${file.type})`);

            // Check file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                return { valid: false, error: 'File type not supported. Please upload JPG, PNG, or PDF files only.' };
            }

            // Check file size (5MB limit)
            const maxSize = 5 * 1024 * 1024; // 5MB
            if (file.size > maxSize) {
                return { valid: false, error: 'File size too large. Please upload files smaller than 5MB.' };
            }

            // Check if file is not empty
            if (file.size === 0) {
                return { valid: false, error: 'File appears to be empty. Please select a valid file.' };
            }

            log('‚úÖ File validation passed');
            return { valid: true };
        }

        async function uploadDocument(file, documentType, userId) {
            try {
                log(`üöÄ Starting Cloudinary upload for ${file.name}`);

                // Validate file before upload
                const validation = validateFile(file);
                if (!validation.valid) {
                    log(`‚ùå File validation failed: ${validation.error}`);
                    return { success: false, error: validation.error };
                }

                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', `ucaes/admissions/${userId}/${documentType}`);
                formData.append('public_id', `${userId}_${documentType}_${Date.now()}`);
                formData.append('tags', 'admissions,ucaes,document,academic-background');

                log(`üì¶ FormData created with parameters:`);
                log(`   - upload_preset: ${CLOUDINARY_UPLOAD_PRESET}`);
                log(`   - folder: ucaes/admissions/${userId}/${documentType}`);
                log(`   - tags: admissions,ucaes,document,academic-background`);

                // Upload to Cloudinary
                const response = await fetch(CLOUDINARY_API_URL, {
                    method: 'POST',
                    body: formData,
                });

                log(`üì° Response received: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Upload failed: ${errorText}`);
                    return { success: false, error: `Upload failed: ${response.statusText}` };
                }

                const result = await response.json();
                log(`‚úÖ Upload successful!`);
                log(`   Secure URL: ${result.secure_url}`);
                log(`   Public ID: ${result.public_id}`);

                return {
                    success: true,
                    url: result.secure_url,
                    publicId: result.public_id,
                };
            } catch (error) {
                log(`üí• Upload error: ${error.message}`);
                return { success: false, error: error.message };
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('testFile');
            const files = Array.from(fileInput.files || []);
            
            if (files.length === 0) {
                alert('Please select one or more files first');
                return;
            }

            clearLog();
            log(`üìÅ Testing upload of ${files.length} file(s)...`);

            const uploadBtn = document.getElementById('uploadBtn');
            const resultDiv = document.getElementById('result');
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            resultDiv.innerHTML = '';

            try {
                const testUserId = 'test-user-' + Date.now();
                const uploadedCertificates = [];

                // Upload each file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    log(`üöÄ Uploading file ${i + 1}/${files.length}: ${file.name}`);

                    const result = await uploadDocument(file, 'certificate', testUserId);

                    if (result.success && result.url && result.publicId) {
                        uploadedCertificates.push({
                            name: file.name,
                            url: result.url,
                            publicId: result.publicId,
                            uploadedAt: new Date().toISOString()
                        });
                        log(`‚úÖ File ${i + 1} uploaded successfully: ${result.url}`);
                    } else {
                        throw new Error(`Failed to upload "${file.name}": ${result.error || 'Unknown error'}`);
                    }
                }

                log(`üéâ All files uploaded successfully!`);
                
                // Show results
                let html = '<div class="success"><h3>‚úÖ Upload Successful!</h3>';
                html += `<p>Uploaded ${uploadedCertificates.length} file(s) to Cloudinary:</p><ul>`;
                
                uploadedCertificates.forEach(cert => {
                    html += `<li><a href="${cert.url}" target="_blank">${cert.name}</a> (ID: ${cert.publicId})</li>`;
                });
                
                html += '</ul></div>';
                resultDiv.innerHTML = html;

            } catch (error) {
                log(`‚ùå Upload test failed: ${error.message}`);
                resultDiv.innerHTML = `<div class="error"><h3>‚ùå Upload Failed</h3><p>${error.message}</p></div>`;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Test Upload to Cloudinary';
            }
        }
    </script>
</body>
</html>


